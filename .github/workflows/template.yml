name: Run Tests

on:
  workflow_call:
    inputs:
      os:
        type: string
        default: ubuntu-latest
      command:
        required: true
        type: string

jobs:
  
  test:

    name: ${{ matrix.openapi }}.${{ matrix.format }} (${{ matrix.version }}) ${{ inputs.os }}
    runs-on: ${{ inputs.os }}
    timeout-minutes: 10
    
    strategy:
      matrix:
        format: [ json, yaml ]
        version: [ v2.0, v3.0 ]
        openapi: [
          "api-with-examples",
          "callback-example",
          "link-example",
          "uber",
          "uspto",
          "petstore",
          "petstore-expanded",
          "petstore-minimal",
          "petstore-simple",
          "petstore-with-external-docs",
          "ingram-micro",
          "hubspot-events",
          "hubspot-webhooks"
        ]
        args: [ 
          "--output-type OneFile", 
          "--output-type OneRequestPerFile"
        ]

    steps:
    - name: 🛒 Checkout repository
      uses: actions/checkout@v3
      
    - uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: 🛠️ Prepare OpenAPI Spec
      id: prepare_openapi_spec
      run: |
        $filename = "./OpenAPI/${{ matrix.version }}/${{ matrix.openapi }}.${{ matrix.format }}"
        $exists = Test-Path -Path $filename -PathType Leaf
        if ($exists -eq $true) {
          Copy-Item $filename ./openapi.${{ matrix.format }}
          "exists=$true" >> $env:GITHUB_OUTPUT
        } else {
          "exists=$false" >> $env:GITHUB_OUTPUT
        }
      working-directory: test
      shell: pwsh

    - name: 🛠️ Generate code
      run: ${{ inputs.command }} ./openapi.${{ matrix.format }} --no-logging ${{ matrix.args }}
      working-directory: test
      shell: pwsh
      if: steps.prepare_openapi_spec.outputs.exists == 'True'
    
    - name: 🛠️ Publish generated code as Artifact
      uses: actions/upload-artifact@v3
      with:
        name: Generated Code (${{ matrix.openapi }}.${{ matrix.format }}, ${{ matrix.version }}, ${{ inputs.os }})
        path: test/*.http
      if: steps.prepare_openapi_spec.outputs.exists == 'True'